<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Review Email</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 30px; }
        .container { max-width: 800px; }
    </style>
</head>
<body>

<div class="container">
    <div class="step-indicator text-center mb-4">
        <span class="step-badge" style="display:inline-block;width:30px;height:30px;line-height:30px;border-radius:50%;background:#e9ecef;color:#6c757d;margin:0 5px;text-align:center;">1</span>
        <span class="step-badge" style="display:inline-block;width:30px;height:30px;line-height:30px;border-radius:50%;background:#e9ecef;color:#6c757d;margin:0 5px;text-align:center;">2</span>
        <span class="step-badge active" style="display:inline-block;width:30px;height:30px;line-height:30px;border-radius:50%;background:#0d6efd;color:white;margin:0 5px;text-align:center;font-weight:bold;">3</span>
        <h4 class="mt-2">Review & Send</h4>
        <a href="/upload" class="text-decoration-none small">‚Üê Back to Processing</a>
    </div>
    
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-warning">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="card mt-3">
        <div class="card-body">
            <h5 class="card-title">Draft Email</h5>
            <p class="text-muted small">AI matched with resume: <b>{{ data.resume_name }}</b></p>
            
            <form id="sendForm" method="POST" action="/preview">
                <!-- Data Fields -->
                <div class="mb-3">
                    <label class="form-label">To (Recruiter)</label>
                    <input type="email" name="recipient" class="form-control" value="{{ data.recruiter_email }}" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Subject</label>
                    <input type="text" name="subject" class="form-control" value="{{ data.subject }}" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Body</label>
                    <textarea name="body" class="form-control" rows="10" required>{{ data.body }}</textarea>
                </div>

                <!-- Hidden Credentials Fields (Populated by JS) -->
                <input type="hidden" name="email_user" id="hidden_email">
                <input type="hidden" name="email_pass" id="hidden_pass">
                <input type="hidden" name="service" id="hidden_service">
                <input type="hidden" name="send_method" id="send_method">

                <hr>
                <h5>3. Send Options</h5>
                
                <div class="row g-2">
                    <div class="col-md-4">
                        <button type="button" onclick="submitSend('smtp')" class="btn btn-success w-100">
                            üöÄ Send Now (SMTP)
                        </button>
                        <div class="form-text small text-center">Uses saved credentials</div>
                    </div>
                    
                    <div class="col-md-4">
                        <button type="button" onclick="openGmail()" class="btn btn-outline-primary w-100">
                            ‚òÅÔ∏è Open in Gmail
                        </button>
                        <div class="form-text small text-center">Browser draft (Manual send)</div>
                    </div>
                    
                    {% if local_outlook %}
                    <div class="col-md-4">
                        <button type="button" onclick="submitSend('desktop')" class="btn btn-outline-dark w-100">
                            üñ•Ô∏è Outlook Desktop
                        </button>
                    </div>
                    {% endif %}
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    function populateCredentials() {
        document.getElementById('hidden_email').value = localStorage.getItem("jobApp_email") || "";
        document.getElementById('hidden_pass').value = localStorage.getItem("jobApp_pass") || "";
        document.getElementById('hidden_service').value = localStorage.getItem("jobApp_service") || "gmail";
    }

    function submitSend(method) {
        populateCredentials();
        document.getElementById('send_method').value = method;
        
        // Validation for SMTP
        if (method === 'smtp') {
            if (!document.getElementById('hidden_email').value || !document.getElementById('hidden_pass').value) {
                alert("Please go back and enter your Email & App Password in the settings.");
                return;
            }
        }
        
        document.getElementById('sendForm').submit();
    }
    
    function openGmail() {
        const to = document.querySelector('[name="recipient"]').value;
        const sub = encodeURIComponent(document.querySelector('[name="subject"]').value);
        const body = encodeURIComponent(document.querySelector('[name="body"]').value);
        const url = `https://mail.google.com/mail/?view=cm&fs=1&to=${to}&su=${sub}&body=${body}`;
        window.open(url, '_blank');
    }
</script>

</body>
</html>
